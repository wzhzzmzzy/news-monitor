# TrendAnalyzor PRD：信源多样性加权与降噪 (Source Diversity Weighting)

## 1. 背景与目标 (Background & Goals)

### 1.1 现状与痛点
目前系统的话题热度评估主要依赖 LLM 对新闻标题的语义判断。由于缺乏信源分布的结构化统计信息，存在以下问题：
- **信源偏差 (Source Bias)**：单一平台（如仅微博或仅知乎）的高频重复报道会导致 LLM 误以为该话题具有极高的全网热度，掩盖了更具社会共识的话题。
- **瞬时噪音 (Transient Noise)**：部分话题仅在特定社交圈层流传，虽然瞬时排名高，但缺乏跨平台的共识，容易干扰每日核心趋势的判断。
- **评分不透明**：在合并相似话题时，现有的 `Math.max` 聚合逻辑过于简单，未能体现信源叠加带来的价值提升。

### 1.2 核心目标
通过引入“信源多样性”维度，对热度评分进行科学修正，确保报告中的核心话题具有更广泛的社会共识或多维度的观察视角，提升报告的权威性与客观性。

## 2. 核心方案：信源加权机制 (Weighting Mechanism)

### 2.1 元数据增强 (Metadata Injection)
在调用 LLM 进行批次分析或生成日报前，需计算并注入以下统计维度：
- `unique_sources_count`: 该话题下涉及的独立信源数量（如 weibo, zhihu, thepaper 等）。
- `source_composition`: 信源的构成类型（官方媒体 vs 社交平台）。
- `global_max_rank`: 该话题下所有报道中出现的最高排名。

### 2.2 评分修正算法 (Algorithmic Adjustment)
引入修正系数 $W_{source}$ 对 LLM 原始评分进行干预：
$$S_{final} = S_{llm} 	imes (0.8 + 0.2 	imes \frac{\min(N_{sources}, 3)}{3})$$
- **单一信源话题**：获得约 86% 的原始热度分，起到抑制作用。
- **双信源话题**：获得约 93% 的原始热度分。
- **三信源及以上话题**：获得 100% 或以上的原始热度分，视为高共识话题。

## 3. 功能详细描述 (Functional Descriptions)

### 3.1 LLM Prompt 指令升级
在 `AnalyzerService` 的指令中引入多样性权重导向：
- **偏好引导**：在 Prompt 中明确告知 LLM，评价核心趋势时应优先考虑具有跨平台共识的话题。即使某些单平台话题排名极高，若缺乏多源验证，其“重要性评分”也应略低于多源覆盖的话题。
- **权重意识**：通过提示词让 LLM 理解，信源列表（sources）的丰富度是衡量话题社会价值的重要维度。

### 3.2 聚合逻辑重构 (`fuzzyDeduplicateTopics`)
- **来源去重累加**：修改 `src/utils/analysis.ts`，在合并相似话题时，将 `newsIds` 对应的信源集合进行并集运算，计算 `uniqueSources`。
- **动态降权**：对于合并后发现仅来自单一信源 ID 的话题，自动应用降权因子。

### 3.3 报告可视化增强
- **多样性标签**：在 HTML 报告中，为跨 3 个以上平台的话题增加“全网热议”勋章。
- **来源明细**：在每个话题的新闻列表中，直观展示来源分布图标，增强信息的可信度。

## 4. 业务逻辑流程 (Business Logic Flow)

1.  **数据采集**：Monitor 抓取原始新闻。
2.  **索引构建**：`processItems` 记录每条新闻的来源列表。
3.  **统计预处理**：在调用 Analyzer 前，计算每个 `NewsIndexItem` 的信源丰富度。
4.  **结构化注入**：Analyzer 将带有来源统计信息的 JSON 传给 LLM。
5.  **语义评估与修正**：LLM 给出初步评分，系统根据信源多样性公式进行二次修正。
6.  **结果分发**：生成并发送最终报告。

## 5. 成功指标 (Success Metrics)
- **话题质量**：日报 Top 5 话题中，跨平台话题（Source > 1）的占比提升至 80% 以上。
- **降噪效果**：单平台营销类或圈层类热点的平均排名下降 2-3 位。
- **鲁棒性**：对于重大单源新闻（如官方独家通报），评分修正不应导致其跌出 Top 10。
